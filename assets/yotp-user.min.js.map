{"version":3,"file":"yotp-user.min.js","sources":["yotp-user.js"],"sourcesContent":["/** global: yotpSettings, ajaxurl */\n(function() {\n\tvar $, form, spinner, btn_submit, list, key_name, otp;\n\n\tfunction showError(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\t$(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-error inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction showSuccess(msg, where)\n\t{\n\t\tvar node = document.querySelector('#' + where + ' + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\t$(where).insertAdjacentHTML('afterend', '<div class=\"notice notice-success inline\"><p>' + msg + '</p></div>');\n\t}\n\n\tfunction hideMessages()\n\t{\n\t\tvar node = document.querySelector('#new-key + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t\tnode = document.querySelector('#registered-keys + .notice');\n\t\tnode && node.parentNode.removeChild(node);\n\t}\n\n\tfunction showSpinner(show)\n\t{\n\t\tif (show) {\n\t\t\tspinner.classList.add('is-active');\n\t\t\tbtn_submit.setAttribute('disabled', '');\n\t\t}\n\t\telse {\n\t\t\tspinner.classList.remove('is-active');\n\t\t\tbtn_submit.removeAttribute('disabled');\n\t\t}\n\t}\n\n\tfunction haveNewItems()\n\t{\n\t\tvar noitems = list.querySelector('tr.no-items')\n\t\tif (noitems) {\n\t\t\tnoitems.parentNode.removeChild(noitems);\n\t\t}\n\t}\n\n\tfunction keyAdded()\n\t{\n\t\tshowSpinner(false);\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(yotpSettings.serverError, 'new-key');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\thaveNewItems();\n\t\t\tlist.insertAdjacentHTML('beforeend', this.response.row);\n\t\t\tshowSuccess(this.response.message, 'new-key');\n\t\t\tkey_name.value = '';\n\t\t\totp.value      = '';\n\t\t\t$('_wpnonce').value = this.response.nonce;\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'new-key');\n\t\t}\n\t}\n\n\tfunction killRow(target)\n\t{\n\t\twhile (target !== null && target.tagName.toUpperCase() !== 'TR') {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\ttarget && target.parentNode.removeChild(target);\n\t}\n\n\tfunction maybeNoItems()\n\t{\n\t\tif (!list.getElementsByTagName('tr').length) {\n\t\t\tvar tpl = document.getElementById('tpl-empty').textContent;\n\t\t\tlist.insertAdjacentHTML('beforeend', tpl);\n\t\t}\n\t}\n\n\tfunction keyRevoked()\n\t{\n\t\tvar spinner = this.tgt.querySelector('.spinner');\n\t\tspinner.classList.remove('is-active');\n\n\t\tif (null === this.response || this.status !== 200) {\n\t\t\tshowError(wwU2F.serverError, 'registered-keys');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.response.ok) {\n\t\t\tshowSuccess(this.response.message, 'registered-keys');\n\t\t\tkillRow(this.tgt);\n\t\t\tmaybeNoItems();\n\t\t}\n\t\telse {\n\t\t\tshowError(this.response.message, 'registered-keys');\n\t\t}\n\t}\n\n\tfunction callback() {\n\t\t$          = document.getElementById.bind(document);\n\t\tform       = $('new-key-form');\n\t\tspinner    = form.querySelector('.spinner');\n\t\tbtn_submit = $('submit-button');\n\t\tlist       = $('the-list');\n\t\tkey_name   = $('key-name');\n\t\totp        = $('otp');\n\n\t\tdocument.querySelector('table.yotp th.column-actions').style.width = 0;\n\n\t\tform.addEventListener('submit', function(e) {\n\t\t\te.preventDefault();\n\t\t\tif (form.reportValidity()) {\n\t\t\t\tvar name  = key_name.value;\n\t\t\t\tvar code  = otp.value;\n\t\t\t\tvar nonce = $('_wpnonce').value;\n\t\t\t\tvar xhr   = new XMLHttpRequest();\n\n\t\t\t\thideMessages();\n\t\t\t\tshowSpinner(true);\n\t\t\t\txhr.open('POST', ajaxurl);\n\t\t\t\txhr.addEventListener('load', keyAdded);\n\t\t\t\txhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\t\txhr.responseType = 'json';\n\t\t\t\txhr.send(\n\t\t\t\t\t   'action=wwyotp_register'\n\t\t\t\t\t+ '&n=' + encodeURIComponent(name) \n\t\t\t\t\t+ '&o=' + encodeURIComponent(code)\n\t\t\t\t\t+ '&_wpnonce=' + encodeURIComponent(nonce)\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\tdocument.querySelector('table.yotp > tbody').addEventListener('click', function(e) {\n\t\t\tvar target = e.target;\n\t\t\twhile (target !== null && (!target.tagName || target.tagName.toUpperCase() !== 'BUTTON' || target.className.indexOf('revoke-button') === -1)) {\n\t\t\t\ttarget = target.parentNode;\n\t\t\t}\n\n\t\t\tif (target && confirm(yotpSettings.revconfirm)) {\n\t\t\t\tvar key    = target.dataset.key;\n\t\t\t\tvar nonce  = target.dataset.nonce;\n\t\t\t\tvar req    = new XMLHttpRequest();\n\t\t\t\treq.tgt    = target;\n\t\t\t\treq.addEventListener('load', keyRevoked);\n\t\t\t\treq.open('POST', ajaxurl);\n\t\t\t\treq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n\t\t\t\treq.responseType = 'json';\n\n\t\t\t\tvar spinner = target.querySelector('.spinner');\n\t\t\t\tspinner.style.float = 'none';\n\t\t\t\tspinner.style.margin = 0;\n\t\t\t\tspinner.classList.add('is-active');\n\t\t\t\thideMessages();\n\n\t\t\t\treq.send(\n\t\t\t\t\t  'action=wwyotp_revoke'\n\t\t\t\t\t+ '&key=' + encodeURIComponent(key) \n\t\t\t\t\t+ '&_wpnonce=' + encodeURIComponent(nonce)\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n\n\tif (document.readyState === 'loading') {\n\t\tdocument.addEventListener('DOMContentLoaded', callback);\n\t}\n\telse {\n\t\tcallback();\n\t}\n})();\n"],"names":["$","form","spinner","btn_submit","list","key_name","otp","showError","msg","where","node","document","querySelector","parentNode","removeChild","insertAdjacentHTML","showSuccess","hideMessages","showSpinner","show","classList","add","setAttribute","remove","removeAttribute","keyAdded","noitems","this","response","status","ok","row","message","value","nonce","yotpSettings","serverError","keyRevoked","tgt","target","tagName","toUpperCase","killRow","getElementsByTagName","length","tpl","getElementById","textContent","maybeNoItems","wwU2F","callback","bind","style","width","addEventListener","e","preventDefault","reportValidity","name","code","xhr","XMLHttpRequest","open","ajaxurl","setRequestHeader","responseType","send","encodeURIComponent","className","indexOf","confirm","revconfirm","key","dataset","req","float","margin","readyState"],"mappings":"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"}